@model MiniShare.Models.ProductRequest
@{
    ViewData["Title"] = "提交商品申请";
}

<div class="container py-4">
    <h2>提交商品申请</h2>
    <div class="alert alert-info">
        请填写您想上架的商品信息。提交后将由管理员审核，通过后商品才会出现在商城中。
    </div>
    <form asp-action="Create" method="post" enctype="multipart/form-data">
        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>
        
        <div class="mb-3">
            <label asp-for="Name" class="form-label">商品名称</label>
            <input asp-for="Name" class="form-control" />
            <span asp-validation-for="Name" class="text-danger"></span>
        </div>
        
        <div class="mb-3">
            <label asp-for="Price" class="form-label">价格</label>
            <input asp-for="Price" type="number" step="0.01" class="form-control" />
            <span asp-validation-for="Price" class="text-danger"></span>
        </div>
        
        <div class="mb-3">
            <label asp-for="Description" class="form-label">描述</label>
            <textarea asp-for="Description" rows="5" class="form-control"></textarea>
            <span asp-validation-for="Description" class="text-danger"></span>
        </div>
        
        <div class="mb-4 border-top pt-4">
            <h5>配送信息</h5>
            
            <div class="mb-3">
                <label asp-for="ShippingTimeHours" class="form-label">发货时间（小时）</label>
                <input asp-for="ShippingTimeHours" type="number" step="1" min="0" class="form-control" />
                <span asp-validation-for="ShippingTimeHours" class="text-danger"></span>
                <small class="form-text text-muted">预计在多长时间内发货</small>
            </div>
            
            <div class="mb-3">
                <label asp-for="ShippingMethod" class="form-label">配送方式</label>
                <select asp-for="ShippingMethod" class="form-select">
                    <option value="0">快递配送</option>
                    <option value="1">面交</option>
                </select>
                <span asp-validation-for="ShippingMethod" class="text-danger"></span>
            </div>
            
            <div class="mb-3">
                <label asp-for="ShippingFee" class="form-label">运费</label>
                <input asp-for="ShippingFee" type="number" step="0.01" min="0" class="form-control" />
                <span asp-validation-for="ShippingFee" class="text-danger"></span>
                <small class="form-text text-muted">设置为0表示免运费</small>
            </div>
        </div>
        
        <div class="mb-3">
            <label class="form-label">商品图片 <span class="text-danger">*</span></label>
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                请至少上传一张商品图片，第一张图片将作为商品主图显示在商品列表中。
            </div>
            <div class="d-flex gap-2 mb-3">
                <input type="file" id="imageInput" accept="image/*" class="form-control" />
                <button type="button" id="addImageBtn" class="btn btn-primary">
                    <i class="fas fa-plus"></i> 添加图片
                </button>
            </div>
            <small class="form-text text-muted">支持 JPG、PNG、GIF 格式，最多上传5张，每张不超过5MB</small>
            <div id="imagePreview" class="mt-3 d-flex flex-wrap gap-2"></div>
            <input type="hidden" id="imageCount" value="0" />
            <!-- 用于存储已选择的图片 -->
            <input type="hidden" id="selectedImages" name="productImages" />
            <!-- 实际提交的文件列表 -->
            <div id="fileList"></div>
        </div>
        
        <div class="mb-3">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-paper-plane me-2"></i>提交申请
            </button>
            <a asp-action="Index" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>返回列表
            </a>
        </div>
    </form>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        $(document).ready(function() {
            const maxImages = 5;
            let selectedFiles = [];
            const preview = $('#imagePreview');
            const imageInput = $('#imageInput');
            const addImageBtn = $('#addImageBtn');
            const fileList = $('#fileList');
            const imageCount = $('#imageCount');

            // 添加图片按钮点击事件
            addImageBtn.on('click', function() {
                const file = imageInput[0].files[0];
                if (!file) {
                    alert('请先选择一张图片');
                    return;
                }

                // 检查图片类型
                if (!file.type.startsWith('image/')) {
                    alert('只能上传图片文件');
                    imageInput.val('');
                    return;
                }

                // 检查图片大小
                if (file.size > 5 * 1024 * 1024) {
                    alert('图片大小不能超过5MB');
                    imageInput.val('');
                    return;
                }

                // 检查图片数量
                if (selectedFiles.length >= maxImages) {
                    alert(`最多只能上传${maxImages}张图片`);
                    imageInput.val('');
                    return;
                }

                // 添加到选中文件列表
                selectedFiles.push(file);
                updateImageCount();
                updateImagePreview();
                imageInput.val('');
            });

            // 更新图片数量
            function updateImageCount() {
                imageCount.val(selectedFiles.length);
            }

            // 更新图片预览
            function updateImagePreview() {
                preview.empty();
                fileList.empty();

                selectedFiles.forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imgContainer = $('<div>')
                            .addClass('position-relative')
                            .css({
                                'width': '150px',
                                'height': '150px',
                                'border': '2px solid #dee2e6',
                                'border-radius': '8px',
                                'overflow': 'hidden'
                            });

                        const img = $('<img>')
                            .attr('src', e.target.result)
                            .css({
                                'width': '100%',
                                'height': '100%',
                                'object-fit': 'cover'
                            });

                        // 删除按钮
                        const deleteBtn = $('<button>')
                            .addClass('position-absolute top-0 end-0 bg-danger text-white border-0 rounded-circle p-2')
                            .css({
                                'width': '30px',
                                'height': '30px',
                                'display': 'flex',
                                'align-items': 'center',
                                'justify-content': 'center',
                                'cursor': 'pointer',
                                'font-size': '12px',
                                'z-index': '10'
                            })
                            .html('<i class="fas fa-times"></i>')
                            .on('click', function() {
                                removeImage(index);
                            });

                        // 主图标识
                        if (index === 0) {
                            const mainBadge = $('<div>')
                                .addClass('position-absolute bottom-0 start-0 bg-primary text-white text-xs px-2 py-1 rounded-end')
                                .text('主图');
                            imgContainer.append(mainBadge);
                        }

                        imgContainer.append(img);
                        imgContainer.append(deleteBtn);
                        preview.append(imgContainer);

                        // 创建隐藏的文件输入，用于表单提交
                        const hiddenInput = $('<input>')
                            .attr('type', 'file')
                            .attr('name', 'productImages')
                            .attr('accept', 'image/*')
                            .attr('style', 'display: none')
                            .prop('files', [file]);
                        fileList.append(hiddenInput);
                    };
                    reader.readAsDataURL(file);
                });
            }

            // 移除图片
            function removeImage(index) {
                selectedFiles.splice(index, 1);
                updateImageCount();
                updateImagePreview();
            }

            // 表单提交前验证
            $('form').on('submit', function() {
                if (selectedFiles.length === 0) {
                    alert('请至少上传一张商品图片');
                    return false;
                }
                return true;
            });
        });
    </script>
}

