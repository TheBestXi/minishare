@model MiniShare.Models.ProductRequest
@{
    ViewData["Title"] = "提交商品申请";
}

<div class="container py-4">
    <h2>提交商品申请</h2>
    <div class="alert alert-info">
        请填写您想上架的商品信息。提交后将由管理员审核，通过后商品才会出现在商城中。
    </div>
    <form asp-action="Create" method="post" enctype="multipart/form-data">
        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>
        
        <div class="mb-3">
            <label asp-for="Name" class="form-label">商品名称</label>
            <input asp-for="Name" class="form-control" />
            <span asp-validation-for="Name" class="text-danger"></span>
        </div>
        
        <div class="mb-3">
            <label asp-for="Price" class="form-label">价格</label>
            <input asp-for="Price" type="number" step="0.01" class="form-control" />
            <span asp-validation-for="Price" class="text-danger"></span>
        </div>
        
        <div class="mb-3">
            <label asp-for="Description" class="form-label">描述</label>
            <textarea asp-for="Description" rows="5" class="form-control"></textarea>
            <span asp-validation-for="Description" class="text-danger"></span>
        </div>
        
        <div class="mb-4 border-top pt-4">
            <h5>配送信息</h5>
            
            <div class="mb-3">
                <label asp-for="ShippingTimeHours" class="form-label">发货时间（小时）</label>
                <input asp-for="ShippingTimeHours" type="number" step="1" min="0" class="form-control" />
                <span asp-validation-for="ShippingTimeHours" class="text-danger"></span>
                <small class="form-text text-muted">预计在多长时间内发货</small>
            </div>
            
            <div class="mb-3">
                <label asp-for="ShippingMethod" class="form-label">配送方式</label>
                <select asp-for="ShippingMethod" class="form-select">
                    <option value="0">快递配送</option>
                    <option value="1">面交</option>
                </select>
                <span asp-validation-for="ShippingMethod" class="text-danger"></span>
            </div>
            
            <div class="mb-3">
                <label asp-for="ShippingFee" class="form-label">运费</label>
                <input asp-for="ShippingFee" type="number" step="0.01" min="0" class="form-control" />
                <span asp-validation-for="ShippingFee" class="text-danger"></span>
                <small class="form-text text-muted">设置为0表示免运费</small>
            </div>
        </div>
        
        <div class="mb-3">
            <label class="form-label">商品图片 <span class="text-danger">*</span></label>
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                请至少上传一张商品图片，第一张图片将作为商品主图显示在商品列表中。
            </div>
            <!-- 隐藏原始文件输入 -->
            <input type="file" name="productImages" multiple accept="image/*" class="form-control d-none" id="productImages" required />
            <!-- 自定义文件选择按钮 -->
            <button type="button" class="btn btn-outline-primary mb-3" onclick="document.getElementById('productImages').click()">
                <i class="fas fa-plus me-2"></i>选择图片
            </button>
            <small class="form-text text-muted">支持 JPG、PNG、GIF 格式，最多上传5张，每张不超过5MB</small>
            <div id="imagePreview" class="mt-3 d-flex flex-wrap gap-2"></div>
        </div>
        
        <div class="mb-3">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-paper-plane me-2"></i>提交申请
            </button>
            <a asp-action="Index" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>返回列表
            </a>
        </div>
    </form>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        $(document).ready(function() {
            const maxImages = 5;
            let selectedFiles = [];
            const fileInput = $('#productImages');
            const preview = $('#imagePreview');
            
            // 创建自定义文件输入，用于提交表单
            const customFileInput = $('<input type="file" name="productImages" multiple accept="image/*" style="display: none;">');
            $('form').append(customFileInput);
            
            // 图片选择和预览功能
            fileInput.on('change', function(e) {
                const files = Array.from(e.target.files);
                
                // 检查总数
                if (selectedFiles.length + files.length > maxImages) {
                    alert(`最多只能上传${maxImages}张图片`);
                    return;
                }
                
                files.forEach(file => {
                    if (!file.type.startsWith('image/')) {
                        alert('只能上传图片文件');
                        return;
                    }
                    
                    if (file.size > 5 * 1024 * 1024) {
                        alert(`图片 ${file.name} 超过5MB，已跳过`);
                        return;
                    }
                    
                    selectedFiles.push(file);
                });
                
                updatePreview();
                updateFileInput();
            });
            
            // 更新预览
            function updatePreview() {
                preview.empty();
                
                selectedFiles.forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imgContainer = $('<div>')
                            .addClass('position-relative')
                            .css({
                                'width': '150px',
                                'height': '150px',
                                'border': '2px solid #dee2e6',
                                'border-radius': '8px',
                                'overflow': 'hidden'
                            });
                        
                        const img = $('<img>')
                            .attr('src', e.target.result)
                            .css({
                                'width': '100%',
                                'height': '100%',
                                'object-fit': 'cover'
                            });
                        
                        // 添加主图标记
                        if (index === 0) {
                            const mainBadge = $('<span>')
                                .addClass('badge bg-primary position-absolute top-0 start-0 m-2')
                                .text('主图');
                            imgContainer.append(mainBadge);
                        }
                        
                        // 添加删除按钮
                        const deleteBtn = $('<button>')
                            .addClass('btn btn-danger btn-sm position-absolute bottom-0 end-0 m-2')
                            .html('<i class="fas fa-times"></i>')
                            .attr('type', 'button')
                            .css({'z-index': '10', 'width': '30px', 'height': '30px', 'padding': '0', 'display': 'flex', 'align-items': 'center', 'justify-content': 'center'})
                            .on('click', function() {
                                deleteImage(index);
                            });
                        
                        imgContainer.append(img);
                        imgContainer.append(deleteBtn);
                        preview.append(imgContainer);
                    };
                    reader.readAsDataURL(file);
                });
            }
            
            // 删除图片
            function deleteImage(index) {
                selectedFiles.splice(index, 1);
                updatePreview();
                updateFileInput();
            }
            
            // 更新自定义文件输入，用于表单提交
            function updateFileInput() {
                // 清空文件输入
                customFileInput.val('');
                
                // 如果没有选中文件，不需要处理
                if (selectedFiles.length === 0) {
                    return;
                }
                
                // 创建一个新的FileList
                const dataTransfer = new DataTransfer();
                selectedFiles.forEach(file => {
                    dataTransfer.items.add(file);
                });
                
                // 设置新的FileList到自定义文件输入
                customFileInput[0].files = dataTransfer.files;
            }
        });
    </script>
}

