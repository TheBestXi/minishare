@model MiniShare.Models.Post
@{
    ViewData["Title"] = "发帖";
}

<div class="container py-4">
    <h2 class="mb-4">发布新帖</h2>
    
    <form asp-action="Create" method="post" enctype="multipart/form-data">
        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>
        
        <div class="mb-3">
            <label asp-for="Title" class="form-label fw-bold">标题 <span class="text-danger">*</span></label>
            <input asp-for="Title" class="form-control" placeholder="请输入帖子标题" />
            <span asp-validation-for="Title" class="text-danger"></span>
        </div>
        
        <div class="mb-3">
            <label asp-for="Content" class="form-label fw-bold">内容 <span class="text-danger">*</span></label>
            <textarea asp-for="Content" rows="10" class="form-control" placeholder="请输入帖子内容..."></textarea>
            <span asp-validation-for="Content" class="text-danger"></span>
        </div>
        
        <div class="mb-3">
            <label class="form-label fw-bold">图片上传</label>
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                最多可以上传9张图片，第一张图片将作为帖子主图显示在列表中。
            </div>
            <input type="file" name="images" multiple accept="image/*" class="form-control" id="imageInput" />
            <small class="form-text text-muted">支持 JPG、PNG、GIF 格式，每张不超过5MB</small>
            <div id="imagePreview" class="mt-3 d-flex flex-wrap gap-2"></div>
            <span id="imageCount" class="text-muted small"></span>
        </div>
        
        <div class="mb-3 d-flex gap-2">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-paper-plane me-2"></i>发布
            </button>
            <a asp-action="Index" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>返回列表
            </a>
        </div>
    </form>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        $(document).ready(function() {
            const maxImages = 9;
            let selectedFiles = [];

            $('#imageInput').on('change', function(e) {
                const files = Array.from(e.target.files);
                const preview = $('#imagePreview');
                const countSpan = $('#imageCount');
                
                // 检查总数
                if (files.length > maxImages) {
                    alert(`最多只能上传${maxImages}张图片`);
                    $(this).val('');
                    selectedFiles = [];
                    preview.empty();
                    countSpan.text('');
                    return;
                }
                
                selectedFiles = files;
                preview.empty();
                
                files.forEach((file, index) => {
                    if (!file.type.startsWith('image/')) {
                        alert('只能上传图片文件');
                        return;
                    }
                    
                    if (file.size > 5 * 1024 * 1024) {
                        alert(`图片 ${file.name} 超过5MB，已跳过`);
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imgContainer = $('<div>')
                            .addClass('position-relative')
                            .css({
                                'width': '150px',
                                'height': '150px',
                                'border': '2px solid #dee2e6',
                                'border-radius': '8px',
                                'overflow': 'hidden'
                            });
                        
                        const img = $('<img>')
                            .attr('src', e.target.result)
                            .css({
                                'width': '100%',
                                'height': '100%',
                                'object-fit': 'cover'
                            });
                        
                        if (index === 0) {
                            const badge = $('<span>')
                                .addClass('badge bg-primary position-absolute top-0 start-0 m-2')
                                .text('主图');
                            imgContainer.append(badge);
                        }
                        
                        imgContainer.append(img);
                        preview.append(imgContainer);
                    };
                    reader.readAsDataURL(file);
                });
                
                countSpan.text(`已选择 ${files.length} 张图片${files.length > 0 ? '（第一张为主图）' : ''}`);
            });
        });
    </script>
}