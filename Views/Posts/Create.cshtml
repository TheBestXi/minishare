@model MiniShare.Models.Post
@{
    ViewData["Title"] = "发帖";
}

<div class="container py-4">
    <h2 class="mb-4">发布新帖</h2>
    
    <form asp-action="Create" method="post" enctype="multipart/form-data">
        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>
        
        <div class="mb-3">
            <label asp-for="Title" class="form-label fw-bold">标题 <span class="text-danger">*</span></label>
            <input asp-for="Title" class="form-control" placeholder="请输入帖子标题" />
            <span asp-validation-for="Title" class="text-danger"></span>
        </div>
        
        <div class="mb-3">
            <label asp-for="Content" class="form-label fw-bold">内容 <span class="text-danger">*</span></label>
            <textarea asp-for="Content" rows="10" class="form-control" placeholder="请输入帖子内容..."></textarea>
            <span asp-validation-for="Content" class="text-danger"></span>
        </div>
        
        <div class="mb-3">
            <label class="form-label fw-bold">图片上传</label>
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                最多可以上传9张图片，第一张图片将作为帖子主图显示在列表中。
            </div>
            <div class="d-flex gap-2 mb-3">
                <input type="file" id="imageInput" accept="image/*" class="form-control" />
                <button type="button" id="addImageBtn" class="btn btn-primary">
                    <i class="fas fa-plus"></i> 添加图片
                </button>
            </div>
            <small class="form-text text-muted">支持 JPG、PNG、GIF 格式，每张不超过5MB</small>
            <div id="imagePreview" class="mt-3 d-flex flex-wrap gap-2"></div>
            <span id="imageCount" class="text-muted small"></span>
            <!-- 实际提交的文件列表 -->
            <div id="fileList"></div>
        </div>
        
        <div class="mb-3 d-flex gap-2">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-paper-plane me-2"></i>发布
            </button>
            <a asp-action="Index" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>返回列表
            </a>
        </div>
    </form>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        $(document).ready(function() {
            const maxImages = 9;
            let selectedFiles = [];
            const preview = $('#imagePreview');
            const imageInput = $('#imageInput');
            const addImageBtn = $('#addImageBtn');
            const fileList = $('#fileList');
            const countSpan = $('#imageCount');

            // 添加图片按钮点击事件
            addImageBtn.on('click', function() {
                const file = imageInput[0].files[0];
                if (!file) {
                    alert('请先选择一张图片');
                    return;
                }

                // 检查图片类型
                if (!file.type.startsWith('image/')) {
                    alert('只能上传图片文件');
                    imageInput.val('');
                    return;
                }

                // 检查图片大小
                if (file.size > 5 * 1024 * 1024) {
                    alert('图片大小不能超过5MB');
                    imageInput.val('');
                    return;
                }

                // 检查图片数量
                if (selectedFiles.length >= maxImages) {
                    alert(`最多只能上传${maxImages}张图片`);
                    imageInput.val('');
                    return;
                }

                // 添加到选中文件列表
                selectedFiles.push(file);
                updateImageCount();
                updateImagePreview();
                imageInput.val('');
            });

            // 更新图片数量显示
            function updateImageCount() {
                countSpan.text(`已选择 ${selectedFiles.length} 张图片${selectedFiles.length > 0 ? '（第一张为主图）' : ''}`);
            }

            // 更新图片预览
            function updateImagePreview() {
                preview.empty();
                fileList.empty();

                selectedFiles.forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imgContainer = $('<div>')
                            .addClass('position-relative')
                            .css({
                                'width': '150px',
                                'height': '150px',
                                'border': '2px solid #dee2e6',
                                'border-radius': '8px',
                                'overflow': 'hidden'
                            });

                        const img = $('<img>')
                            .attr('src', e.target.result)
                            .css({
                                'width': '100%',
                                'height': '100%',
                                'object-fit': 'cover'
                            });

                        // 删除按钮
                        const deleteBtn = $('<button>')
                            .addClass('position-absolute top-0 end-0 bg-danger text-white border-0 rounded-circle p-2')
                            .css({
                                'width': '30px',
                                'height': '30px',
                                'display': 'flex',
                                'align-items': 'center',
                                'justify-content': 'center',
                                'cursor': 'pointer',
                                'font-size': '12px',
                                'z-index': '10'
                            })
                            .html('<i class="fas fa-times"></i>')
                            .on('click', function() {
                                removeImage(index);
                            });

                        // 主图标识
                        if (index === 0) {
                            const mainBadge = $('<span>')
                                .addClass('badge bg-primary position-absolute top-0 start-0 m-2')
                                .text('主图');
                            imgContainer.append(mainBadge);
                        }

                        imgContainer.append(img);
                        imgContainer.append(deleteBtn);
                        preview.append(imgContainer);

                        // 创建隐藏的文件输入，用于表单提交
                        const hiddenInput = $('<input>')
                            .attr('type', 'file')
                            .attr('name', 'images')
                            .attr('accept', 'image/*')
                            .attr('style', 'display: none')
                            .prop('files', [file]);
                        fileList.append(hiddenInput);
                    };
                    reader.readAsDataURL(file);
                });
            }

            // 移除图片
            function removeImage(index) {
                selectedFiles.splice(index, 1);
                updateImageCount();
                updateImagePreview();
            }
        });
    </script>
}