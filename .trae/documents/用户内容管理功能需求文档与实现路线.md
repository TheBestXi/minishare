# 用户内容管理功能需求文档

## 1. 项目背景
当前系统中，普通用户只能创建帖子和商品，无法管理自己已发布的内容。管理员可以管理所有内容，但缺少对商品修改申请的区分和处理。本需求旨在增强用户对自己内容的管理能力，同时优化管理员的审核流程。

## 2. 功能需求

### 2.1 用户内容管理

#### 2.1.1 帖子管理
- **查看我的帖子**：用户可以查看自己发布的所有帖子列表
- **修改帖子**：用户可以修改自己的帖子，包括：
  - 修改标题和内容
  - 添加、删除或重新排序图片
  - 保留原有评论、点赞和收藏数据
  - 修改后不需要重新审核，直接更新

#### 2.1.2 商品管理
- **查看我的商品**：用户可以查看自己发布的所有商品列表
- **修改商品**：用户可以修改自己的商品，包括：
  - 修改名称、价格、描述
  - 添加、删除或重新排序图片
  - 修改配送信息（发货时间、配送方式、运费）
  - 修改后需要提交管理员审核，审核通过后才会更新

### 2.2 管理员审核功能

#### 2.2.1 商品申请管理
- **区分申请类型**：在商品申请列表中区分"新商品申请"和"商品修改申请"
- **查看修改详情**：查看商品修改前后的差异
- **审核操作**：对修改申请进行批准或拒绝
- **审核记录**：记录审核操作和备注

## 3. 非功能需求

### 3.1 性能要求
- 页面加载时间不超过2秒
- 内容修改操作响应时间不超过1秒

### 3.2 安全性要求
- 用户只能修改自己发布的内容
- 商品修改必须经过管理员审核
- 所有操作必须验证用户身份

### 3.3 可用性要求
- 操作流程简单直观
- 提供清晰的操作反馈
- 支持撤销操作

## 4. 技术实现方案

### 4.1 数据模型设计

#### 4.1.1 帖子模型（已有）
- 无需修改，直接使用现有模型

#### 4.1.2 商品申请模型（扩展）
- 在`ProductRequest`模型中添加`OriginalProductId`字段，用于标识是修改申请
- 类型：int?，允许为空
- 关联：外键关联到`Product`表

### 4.2 控制器设计

#### 4.2.1 帖子管理控制器（扩展）
- 在`PostsController`中添加以下方法：
  - `MyPosts()`：查看用户自己的帖子列表
  - `Edit(int id)`：编辑帖子页面
  - `Edit(Post model, List<IFormFile>? images)`：保存帖子修改

#### 4.2.2 商品管理控制器（扩展）
- 在`ProductsController`中添加以下方法：
  - `MyProducts()`：查看用户自己的商品列表
  - `Edit(int id)`：编辑商品页面
  - `Edit(ProductRequest request, List<IFormFile> productImages)`：提交商品修改申请

#### 4.2.3 管理员审核控制器（扩展）
- 在`AdminController`中修改`ProductRequests()`方法，添加申请类型区分
- 修改`ApproveRequest()`方法，支持处理商品修改申请

### 4.3 视图设计

#### 4.3.1 帖子管理视图
- `MyPosts.cshtml`：用户帖子列表页
- `Edit.cshtml`：帖子编辑页

#### 4.3.2 商品管理视图
- `MyProducts.cshtml`：用户商品列表页
- `Edit.cshtml`：商品编辑页

#### 4.3.3 管理员审核视图
- 修改`ProductRequests.cshtml`，添加申请类型标识
- 添加修改详情对比视图

### 4.4 实现路线

#### 4.4.1 第一阶段：数据模型扩展（1天）
1. 扩展`ProductRequest`模型，添加`OriginalProductId`字段
2. 生成并应用数据库迁移

#### 4.4.2 第二阶段：帖子管理功能实现（2天）
1. 在`PostsController`中添加`MyPosts`方法
2. 添加`Edit` GET和POST方法
3. 创建对应的视图文件
4. 实现帖子编辑逻辑，保留原有评论、点赞和收藏

#### 4.4.3 第三阶段：商品管理功能实现（3天）
1. 在`ProductsController`中添加`MyProducts`方法
2. 添加商品修改申请提交功能
3. 实现商品编辑视图
4. 集成图片上传和管理功能

#### 4.4.4 第四阶段：管理员审核功能优化（2天）
1. 修改`AdminController`，支持区分申请类型
2. 修改商品申请列表视图，添加申请类型标识
3. 实现商品修改详情对比功能
4. 完善审核流程

## 5. 预期效果

### 5.1 用户体验
- 用户可以方便地管理自己的帖子和商品
- 帖子修改实时生效，保留原有互动数据
- 商品修改流程清晰，知道需要审核

### 5.2 管理员体验
- 可以区分新商品申请和商品修改申请
- 可以查看商品修改前后的差异
- 审核流程简单直观

## 6. 风险评估

| 风险项 | 风险描述 | 应对措施 |
|--------|----------|----------|
| 数据一致性 | 商品修改申请过程中，原商品可能被删除 | 添加外键约束，确保原商品存在 |
| 审核压力 | 大量商品修改申请可能增加管理员负担 | 实现智能审核建议，优先显示重要修改 |
| 用户体验 | 商品修改需要审核，用户可能等待时间过长 | 提供清晰的审核状态和预计时间 |

# 实现路线方法

## 1. 数据模型扩展

### 1.1 修改`ProductRequest`模型
```csharp
public class ProductRequest
{
    // 现有字段...
    
    /// <summary>
    /// 原始商品ID，用于标识是修改申请
    /// </summary>
    public int? OriginalProductId { get; set; }
    public Product? OriginalProduct { get; set; }
}
```

### 1.2 生成数据库迁移
```bash
dotnet ef migrations add AddOriginalProductIdToProductRequest
dotnet ef database update
```

## 2. 帖子管理功能实现

### 2.1 添加`MyPosts`方法到`PostsController`
```csharp
[Authorize]
public async Task<IActionResult> MyPosts()
{
    var userIdStr = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
    if (string.IsNullOrEmpty(userIdStr) || !int.TryParse(userIdStr, out int userId))
    {
        return Unauthorized();
    }
    
    var posts = await _context.Posts
        .Where(p => p.AuthorId == userId)
        .Include(p => p.Images.OrderBy(img => img.SortOrder))
        .OrderByDescending(p => p.CreatedAt)
        .ToListAsync();
    
    return View(posts);
}
```

### 2.2 添加帖子编辑方法
```csharp
[Authorize]
public async Task<IActionResult> Edit(int id)
{
    var userIdStr = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
    if (string.IsNullOrEmpty(userIdStr) || !int.TryParse(userIdStr, out int userId))
    {
        return Unauthorized();
    }
    
    var post = await _context.Posts
        .Include(p => p.Images.OrderBy(img => img.SortOrder))
        .FirstOrDefaultAsync(p => p.Id == id && p.AuthorId == userId);
    
    if (post == null)
    {
        return NotFound();
    }
    
    return View(post);
}

[Authorize]
[HttpPost]
[ValidateAntiForgeryToken]
public async Task<IActionResult> Edit(Post model, List<IFormFile>? images)
{
    // 实现帖子修改逻辑
    // 1. 验证用户权限
    // 2. 更新帖子基本信息
    // 3. 处理图片上传
    // 4. 保存到数据库
    // 5. 重定向到帖子详情页
}
```

## 3. 商品管理功能实现

### 3.1 添加`MyProducts`方法到`ProductsController`
```csharp
[Authorize]
public async Task<IActionResult> MyProducts()
{
    var userIdStr = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
    if (string.IsNullOrEmpty(userIdStr) || !int.TryParse(userIdStr, out int userId))
    {
        return Unauthorized();
    }
    
    // 获取用户的商品申请
    var requests = await _context.ProductRequests
        .Where(r => r.RequestedById == userId && r.Status == ProductRequestStatus.Approved)
        .ToListAsync();
    
    var productIds = requests.Select(r => r.Id).ToList();
    var products = await _context.Products
        .Where(p => productIds.Contains(p.Id))
        .ToListAsync();
    
    // 获取商品图片
    // ...
    
    return View(products);
}
```

### 3.2 添加商品编辑功能
```csharp
[Authorize]
public async Task<IActionResult> Edit(int id)
{
    // 验证用户权限
    // 获取商品信息
    // 返回编辑视图
}

[Authorize]
[HttpPost]
[ValidateAntiForgeryToken]
public async Task<IActionResult> Edit(ProductRequest request, List<IFormFile> productImages)
{
    // 1. 验证用户权限
    // 2. 创建商品修改申请
    // 3. 保存图片
    // 4. 提交申请，等待管理员审核
    // 5. 重定向到商品列表页
}
```

## 4. 管理员审核功能优化

### 4.1 修改`AdminController.ProductRequests`方法
```csharp
public async Task<IActionResult> ProductRequests()
{
    var requests = await _context.ProductRequests
        .Include(r => r.RequestedBy)
        .Include(r => r.ReviewedBy)
        .Include(r => r.OriginalProduct)
        .OrderByDescending(r => r.CreatedAt)
        .ToListAsync();
    
    return View(requests);
}
```

### 4.2 修改`ApproveRequest`方法，支持商品修改
```csharp
[HttpPost]
[ValidateAntiForgeryToken]
public async Task<IActionResult> ApproveRequest(int id)
{
    var request = await _context.ProductRequests.FindAsync(id);
    // 验证请求状态
    
    if (request.OriginalProductId.HasValue)
    {
        // 处理商品修改申请
        // 1. 获取原商品
        // 2. 更新商品信息
        // 3. 更新商品图片
        // 4. 保存到数据库
    }
    else
    {
        // 处理新商品申请（现有逻辑）
    }
    
    return RedirectToAction(nameof(ProductRequests));
}
```

## 5. 视图实现

### 5.1 创建用户帖子列表视图 `Views/Posts/MyPosts.cshtml`
- 显示用户所有帖子
- 支持分页和搜索
- 每个帖子卡片显示标题、预览图、发布时间等
- 添加编辑按钮

### 5.2 创建帖子编辑视图 `Views/Posts/Edit.cshtml`
- 表单用于修改帖子标题和内容
- 图片上传和管理功能
- 显示现有图片，支持删除和排序

### 5.3 创建用户商品列表视图 `Views/Products/MyProducts.cshtml`
- 显示用户所有商品
- 支持分页和搜索
- 每个商品卡片显示名称、图片、价格等
- 添加编辑按钮

### 5.4 创建商品编辑视图 `Views/Products/Edit.cshtml`
- 表单用于修改商品信息
- 图片上传和管理功能
- 显示现有图片，支持删除和排序

### 5.5 修改商品申请列表视图 `Views/Admin/ProductRequests.cshtml`
- 添加申请类型标识（新商品/修改商品）
- 对于修改申请，显示原商品信息
- 添加查看修改详情按钮

## 6. 测试与部署

### 6.1 单元测试
- 测试用户权限验证
- 测试帖子修改逻辑
- 测试商品修改申请流程
- 测试管理员审核功能

### 6.2 集成测试
- 测试完整的帖子修改流程
- 测试完整的商品修改申请和审核流程

### 6.3 部署
- 更新生产数据库
- 部署最新代码
- 监控系统运行情况

## 7. 后续扩展建议

1. 添加帖子和商品的草稿功能
2. 实现商品修改申请的差异对比视图
3. 添加批量操作功能
4. 实现内容统计和分析功能
5. 添加内容推荐和优化建议

通过以上实现路线，我们可以完成用户内容管理功能的开发，增强用户对自己内容的管理能力，同时优化管理员的审核流程。